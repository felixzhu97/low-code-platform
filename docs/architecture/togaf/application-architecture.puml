@startuml Application_Architecture
!theme plain
skinparam linetype ortho

title TOGAF 应用架构 - Felix 低代码平台

' ============================================
' 应用系统边界
' ============================================

package "Felix 低代码平台应用系统" {
  
  ' ============================================
  ' 表现层应用组件
  ' ============================================
  package "表现层 (Presentation Layer)" {
    
    component [可视化编辑器\nVisual Editor] as VisualEditor
    interface "编辑器接口" as VisualEditorInterface
    
    component [组件面板\nComponent Panel] as ComponentPanel
    interface "组件选择接口" as ComponentPanelInterface
    
    component [属性面板\nProperty Panel] as PropertyPanel
    interface "属性配置接口" as PropertyPanelInterface
    
    component [模板库\nTemplate Library] as TemplateLibrary
    interface "模板管理接口" as TemplateLibraryInterface
    
    component [数据面板\nData Panel] as DataPanel
    interface "数据管理接口" as DataPanelInterface
    
    component [数据源选择器\nDataSource Selector] as DataSourceSelector
    interface "数据源选择接口" as DataSourceSelectorInterface
    
    component [JSON数据输入\nJSON Data Input] as JsonDataInput
    interface "JSON输入接口" as JsonDataInputInterface
    
    component [Schema导出组件\nSchema Export] as SchemaExport
    interface "Schema导出接口" as SchemaExportUIInterface
    
    component [Schema导入组件\nSchema Import] as SchemaImport
    interface "Schema导入接口" as SchemaImportUIInterface
    
    component [Schema渲染器\nSchema Renderer] as SchemaRendererComponent
    interface "Schema渲染接口" as SchemaRendererUIInterface
    
    VisualEditor --> VisualEditorInterface
    ComponentPanel --> ComponentPanelInterface
    PropertyPanel --> PropertyPanelInterface
    TemplateLibrary --> TemplateLibraryInterface
    DataPanel --> DataPanelInterface
    DataSourceSelector --> DataSourceSelectorInterface
    JsonDataInput --> JsonDataInputInterface
    SchemaExport --> SchemaExportUIInterface
    SchemaImport --> SchemaImportUIInterface
    SchemaRendererComponent --> SchemaRendererUIInterface
  }
  
  ' ============================================
  ' 应用层组件
  ' ============================================
  package "应用层 (Application Layer)" {
    
    component [组件管理服务\nComponent Management Service] as ComponentService
    interface "组件操作接口" as ComponentServiceInterface
    
    component [模板管理服务\nTemplate Management Service] as TemplateService
    interface "模板操作接口" as TemplateServiceInterface
    
    component [数据绑定服务\nData Binding Service] as DataBindingService
    interface "数据绑定接口" as DataBindingServiceInterface
    
    component [数据源服务\nDataSource Service] as DataSourceService
    interface "数据源操作接口" as DataSourceServiceInterface
    
    component [数据源结构服务\nDataSource Structure Service] as DataSourceStructureService
    interface "结构解析接口" as DataSourceStructureServiceInterface
    
    component [JSON工具服务\nJSON Helper Service] as JsonHelperService
    interface "JSON操作接口" as JsonHelperServiceInterface
    
    component [模板命令服务\nTemplate Command Service] as TemplateCommandService
    interface "模板命令接口" as TemplateCommandInterface
    
    component [用例层\nUse Cases Layer] as UseCasesLayer
    component [画布用例\nCanvas Use Cases] as CanvasUseCases
    component [组件用例\nComponent Use Cases] as ComponentUseCases
    component [模板用例\nTemplate Use Cases] as TemplateUseCases
    
    component [历史记录工具\nHistory Utils] as HistoryUtils
    note right of HistoryUtils : 函数式实现\n提供 undo/redo/addToHistory 等函数
    
    ComponentService --> ComponentServiceInterface
    TemplateService --> TemplateServiceInterface
    TemplateCommandService --> TemplateCommandInterface
    DataBindingService --> DataBindingServiceInterface
    DataSourceService --> DataSourceServiceInterface
    DataSourceStructureService --> DataSourceStructureServiceInterface
    JsonHelperService --> JsonHelperServiceInterface
    
    UseCasesLayer --> CanvasUseCases
    UseCasesLayer --> ComponentUseCases
    UseCasesLayer --> TemplateUseCases
  }
  
  ' ============================================
  ' 领域层组件
  ' ============================================
  package "领域层 (Domain Layer)" {
    
    component [组件实体\nComponent Entity] as ComponentEntity
    component [模板实体\nTemplate Entity] as TemplateEntity
    component [项目实体\nProject Entity] as ProjectEntity
    component [数据源实体\nDataSource Entity] as DataSourceEntity
    component [Schema实体\nPageSchema Entity] as SchemaEntity
    component [组件工厂\nComponent Factory] as ComponentFactory
  }
  
  ' ============================================
  ' 基础设施层组件
  ' ============================================
  package "基础设施层 (Infrastructure Layer)" {
    
    component [组件仓储\nComponent Repository] as ComponentRepo
    interface "仓储接口" as ComponentRepoInterface
    
    component [模板仓储\nTemplate Repository] as TemplateRepo
    interface "仓储接口" as TemplateRepoInterface
    
    component [数据源仓储\nDataSource Repository] as DataSourceRepo
    interface "仓储接口" as DataSourceRepoInterface
    
    component [状态管理\nState Management] as StateManagement
    interface "状态接口" as StateManagementInterface
    
    component [协作服务\nCollaboration Service] as CollaborationService
    interface "协作接口" as CollaborationServiceInterface
    
    component [持久化管理器\nPersistence Manager] as PersistenceManager
    interface "持久化接口" as PersistenceManagerInterface
    note right of PersistenceManager : 负责 Schema 导出/导入\n项目数据持久化\nlocalStorage 存储管理
    
    component [WASM适配器\nWASM Adapter] as WasmAdapter
    interface "WASM端口接口" as WasmPortInterface
    component [数据解析适配器\nData Parser Adapter] as DataParserAdapter
    component [Schema处理适配器\nSchema Processor Adapter] as SchemaProcessorAdapter
    component [数据映射适配器\nData Mapper Adapter] as DataMapperAdapter
    component [布局计算适配器\nLayout Calculator Adapter] as LayoutCalculatorAdapter
    
    ComponentRepo --> ComponentRepoInterface
    TemplateRepo --> TemplateRepoInterface
    DataSourceRepo --> DataSourceRepoInterface
    StateManagement --> StateManagementInterface
    CollaborationService --> CollaborationServiceInterface
    PersistenceManager --> PersistenceManagerInterface
    
    WasmAdapter --> WasmPortInterface
    WasmAdapter --> DataParserAdapter
    WasmAdapter --> SchemaProcessorAdapter
    WasmAdapter --> DataMapperAdapter
    WasmAdapter --> LayoutCalculatorAdapter
  }
}

' ============================================
' 外部系统
' ============================================

package "外部系统 (External Systems)" {
  component [认证服务\nAuthentication Service] as AuthService
  component [数据库\nDatabase] as Database
  component [缓存服务\nCache Service] as CacheService
  component [对象存储\nObject Storage] as ObjectStorage
  component [Git仓库\nGit Repository] as GitRepo
  component [CDN服务\nCDN Service] as CDNService
  component [WASM模块\nWASM Module] as WasmModule
  component [Rust编译\nRust Compiler] as RustCompiler
  component [Schema包\n@lowcode-platform/schema] as SchemaPackage
  note right of SchemaPackage : Schema 验证、序列化/反序列化\n迁移工具包\n支持 WASM 和 JS 降级
}

' ============================================
' 应用交互关系
' ============================================

VisualEditor --> ComponentService : 调用
VisualEditor --> CanvasUseCases : 调用
VisualEditor --> HistoryUtils : 调用
ComponentPanel --> ComponentService : 调用
PropertyPanel --> ComponentService : 调用
PropertyPanel --> DataBindingService : 调用
TemplateLibrary --> TemplateService : 调用
TemplateLibrary --> TemplateUseCases : 调用
DataPanel --> DataBindingService : 调用
DataPanel --> DataSourceService : 调用
DataSourceSelector --> DataSourceService : 调用
DataSourceSelector --> DataBindingService : 调用
JsonDataInput --> JsonHelperService : 调用
JsonDataInput --> DataSourceStructureService : 调用
SchemaExport --> PersistenceManager : 调用
SchemaImport --> PersistenceManager : 调用
SchemaRendererComponent --> ComponentService : 调用

ComponentService --> ComponentEntity : 使用
ComponentService --> ComponentRepo : 使用
TemplateService --> TemplateEntity : 使用
TemplateService --> TemplateRepo : 使用
DataBindingService --> DataSourceEntity : 使用
DataBindingService --> DataSourceRepo : 使用
DataSourceService --> DataSourceEntity : 使用
DataSourceService --> DataSourceRepo : 使用
DataSourceStructureService --> DataSourceEntity : 使用
JsonHelperService --> DataSourceEntity : 处理
CanvasUseCases --> ComponentFactory : 使用
ComponentUseCases --> ComponentEntity : 使用
TemplateUseCases --> TemplateEntity : 使用
TemplateCommandService --> TemplateEntity : 使用
PersistenceManager --> SchemaEntity : 使用
PersistenceManager --> StateManagement : 使用
SchemaRendererComponent --> SchemaEntity : 使用

DataSourceService --> WasmAdapter : 使用（CSV/XML解析、JSON验证）
PersistenceManager --> SchemaPackage : 使用（Schema操作）
SchemaPackage --> WasmAdapter : 调用（WASM优化）
WasmAdapter --> WasmModule : 调用
DataBindingService --> WasmAdapter : 使用（数据映射生成和应用）
CanvasUseCases --> WasmAdapter : 使用（布局计算、网格对齐、碰撞检测）

WasmAdapter --> WasmModule : 调用
WasmModule --> RustCompiler : 编译

ComponentRepo --> Database : 读写
TemplateRepo --> Database : 读写
DataSourceRepo --> Database : 读写
StateManagement --> CacheService : 读写
PersistenceManager --> CacheService : 读写（localStorage）

CollaborationService --> StateManagement : 同步状态
CollaborationService --> CacheService : 消息队列

ComponentService ..> AuthService : 验证权限
TemplateService ..> AuthService : 验证权限
PersistenceManager ..> AuthService : 验证权限

PersistenceManager --> ObjectStorage : 存储Schema文件（可选）
VisualEditor --> CDNService : 加载静态资源
SchemaRendererComponent --> CDNService : 加载静态资源

' ============================================
' 数据流
' ============================================

note right of VisualEditor
  **主要数据流：**
  1. 组件操作 → 应用服务/用例 → 领域实体 → 状态管理
  2. 数据变更 → 状态管理 → 协作服务 → 历史记录工具
  3. JSON输入 → JSON工具服务 → 数据源服务 → 数据绑定服务 → 组件渲染
  4. 数据源选择 → 数据源服务 → 数据结构解析 → 自动渲染
  5. Schema导出 → PersistenceManager → @lowcode-platform/schema → WASM适配器（序列化） → 文件下载
  6. Schema导入 → PersistenceManager → @lowcode-platform/schema → WASM适配器（验证/迁移/反序列化） → 状态管理 → 画布渲染
  7. Schema渲染 → Schema渲染器组件 → 组件服务 → 画布渲染
  8. CSV/XML解析 → 数据源服务 → WASM适配器（高性能解析） → 数据绑定服务
  9. 数据映射 → 数据绑定服务 → WASM适配器（映射生成/应用） → 组件渲染
  10. 布局计算 → 画布用例 → WASM适配器（布局计算/网格对齐） → 组件位置更新
  11. 模板应用 → 模板服务/命令 → 模板用例 → 组件服务 → 状态管理
end note

@enduml

