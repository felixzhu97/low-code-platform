@startuml Data_Architecture
!theme plain
skinparam linetype ortho

title TOGAF 数据架构 - Felix 低代码平台

' ============================================
' 数据实体组件
' ============================================

package "核心数据实体 (Core Data Entities)" {
  
  component [Component\n组件实体] as Component
  component [id: String] as ComponentId
  component [name: String] as ComponentName
  component [type: String] as ComponentType
  component [props: Object] as ComponentProps
  component [style: Object] as ComponentStyle
  component [position: Position] as ComponentPosition
  component [children: List] as ComponentChildren
  component [parentId: String] as ComponentParentId
  component [dataBinding: Object] as ComponentDataBinding
  
  component [Template\n模板实体] as Template
  component [Template_id: String] as TemplateId
  component [Template_name: String] as TemplateName
  component [Template_description: String] as TemplateDescription
  component [Template_category: String] as TemplateCategory
  component [rootComponent: Component] as TemplateRootComponent
  component [Template_preview: Object] as TemplatePreview
  component [Template_authorId: String] as TemplateAuthorId
  component [Template_isPublic: Boolean] as TemplateIsPublic
  
  component [Project\n项目实体] as Project
  component [Project_id: String] as ProjectId
  component [Project_name: String] as ProjectName
  component [Project_description: String] as ProjectDescription
  component [Project_rootComponent: Component] as ProjectRootComponent
  component [Project_theme: ThemeConfig] as ProjectTheme
  component [Project_dataSources: List] as ProjectDataSources
  component [Project_ownerId: String] as ProjectOwnerId
  component [Project_collaborators: List] as ProjectCollaborators
  component [Project_status: ProjectStatus] as ProjectStatus
  
  component [DataSource\n数据源实体] as DataSource
  component [DataSource_id: String] as DataSourceId
  component [DataSource_name: String] as DataSourceName
  component [DataSource_type: DataSourceType] as DataSourceType
  component [DataSource_config: Object] as DataSourceConfig
  component [DataSource_data: Object] as DataSourceData
  component [DataSource_status: DataSourceStatus] as DataSourceStatus
  component [DataSource_errorMessage: String] as DataSourceErrorMessage
  component [DataSource_lastUpdated: DateTime] as DataSourceLastUpdated
  
  component [JsonDataTemplate\nJSON数据模板] as JsonDataTemplate
  component [JsonTemplate_id: String] as JsonTemplateId
  component [JsonTemplate_name: String] as JsonTemplateName
  component [JsonTemplate_description: String] as JsonTemplateDescription
  component [JsonTemplate_data: Object] as JsonTemplateData
  component [JsonTemplate_componentTypes: List<String>] as JsonTemplateComponentTypes
  component [JsonTemplate_preview: String] as JsonTemplatePreview
  
  component [DataMapping\n数据映射实体] as DataMapping
  component [DataMapping_id: String] as DataMappingId
  component [DataMapping_componentId: String] as DataMappingComponentId
  component [DataMapping_dataSourceId: String] as DataMappingDataSourceId
  component [DataMapping_field: String] as DataMappingField
  component [DataMapping_sourcePath: String] as DataMappingSourcePath
  component [DataMapping_targetPath: String] as DataMappingTargetPath
  component [DataMapping_transform: TransformType] as DataMappingTransform
  component [DataMapping_defaultValue: Any] as DataMappingDefaultValue
  
  component [User\n用户实体] as User
  component [User_id: String] as UserId
  component [User_username: String] as UserUsername
  component [User_email: String] as UserEmail
  component [User_role: String] as UserRole
  component [User_preferences: UserPreferences] as UserPreferences
  
  component [ThemeConfig\n主题配置实体] as ThemeConfig
  component [ThemeConfig_id: String] as ThemeConfigId
  component [ThemeConfig_name: String] as ThemeConfigName
  component [ThemeConfig_colors: ColorPalette] as ThemeConfigColors
  component [ThemeConfig_typography: TypographyConfig] as ThemeConfigTypography
  component [ThemeConfig_spacing: SpacingConfig] as ThemeConfigSpacing
  component [ThemeConfig_isDarkMode: Boolean] as ThemeConfigIsDarkMode
  
  component [HistoryRecord\n历史记录实体] as HistoryRecord
  component [HistoryRecord_id: String] as HistoryRecordId
  component [HistoryRecord_projectId: String] as HistoryRecordProjectId
  component [HistoryRecord_userId: String] as HistoryRecordUserId
  component [HistoryRecord_operation: OperationType] as HistoryRecordOperation
  component [HistoryRecord_data: Object] as HistoryRecordData
  component [HistoryRecord_timestamp: DateTime] as HistoryRecordTimestamp
  
  component [PageSchema\n页面Schema实体] as PageSchema
  component [PageSchema_version: String] as PageSchemaVersion
  component [PageSchema_metadata: SchemaMetadata] as PageSchemaMetadata
  component [PageSchema_components: List<Component>] as PageSchemaComponents
  component [PageSchema_canvas: CanvasConfig] as PageSchemaCanvas
  component [PageSchema_theme: ThemeConfig] as PageSchemaTheme
  component [PageSchema_dataSources: List<DataSource>] as PageSchemaDataSources
  component [PageSchema_settings: ProjectSettings] as PageSchemaSettings
}

' ============================================
' 实体关系
' ============================================

Component "1" *-- "0..*" Component : 父子关系
Project "1" *-- "1" Component : 根组件
Project "1" *-- "0..*" DataSource : 数据源
Project "1" *-- "1" ThemeConfig : 主题配置
Template "1" *-- "1" Component : 根组件
DataSource "1" *-- "0..*" DataMapping : 数据映射
Component "1" *-- "0..*" DataMapping : 数据绑定
Component "1" *-- "0..1" DataSource : 直接绑定
Component "1" *-- "0..1" DataSource : 直接绑定
Project "1" *-- "1" User : 所有者
Project "1" *-- "0..*" User : 协作者
HistoryRecord "1" *-- "1" Project : 历史记录
PageSchema "1" *-- "1" Project : 基于项目
PageSchema "1" *-- "0..*" Component : 包含组件
PageSchema "1" *-- "0..*" DataSource : 包含数据源
PageSchema "1" *-- "1" ThemeConfig : 包含主题

' ============================================
' 数据存储组件
' ============================================

package "数据存储层 (Data Storage Layer)" {
  
  component [PostgreSQL\n关系型数据库] as PostgreSQL
  component [components表] as ComponentsTable
  component [projects表] as ProjectsTable
  component [templates表] as TemplatesTable
  component [data_sources表] as DataSourcesTable
  component [users表] as UsersTable
  component [history_records表] as HistoryRecordsTable
  
  component [Redis\n缓存数据库] as Redis
  component [session_cache] as SessionCache
  component [project_cache] as ProjectCache
  component [collaboration_state] as CollaborationState
  
  component [对象存储\nObject Storage] as ObjectStorage
  component [user_files桶] as UserFilesBucket
  component [exported_code桶] as ExportedCodeBucket
  component [template_previews桶] as TemplatePreviewsBucket
  component [schema_files桶] as SchemaFilesBucket
  
  PostgreSQL --> ComponentsTable
  PostgreSQL --> ProjectsTable
  PostgreSQL --> TemplatesTable
  PostgreSQL --> DataSourcesTable
  PostgreSQL --> DataMappingsTable
  PostgreSQL --> UsersTable
  PostgreSQL --> HistoryRecordsTable
  
  Redis --> SessionCache
  Redis --> ProjectCache
  Redis --> CollaborationState
  
  ObjectStorage --> UserFilesBucket
  ObjectStorage --> ExportedCodeBucket
  ObjectStorage --> TemplatePreviewsBucket
  ObjectStorage --> SchemaFilesBucket
}

' ============================================
' 数据流组件
' ============================================

package "关键数据流场景 (Key Data Flow Scenarios)" {
  
  component [组件编辑数据流] as ComponentEditFlow
  component [用户拖拽组件] as UserDragComponent
  component [编辑器创建Component实体] as EditorCreateComponent
  component [应用服务验证数据] as ServiceValidateData
  component [状态管理更新本地状态] as StateUpdateLocal
  component [协作服务广播操作] as CollaborationBroadcast
  component [仓储持久化到数据库] as RepositoryPersist
  component [缓存更新] as CacheUpdate
  
  component [数据绑定数据流] as DataBindingFlow
  component [用户配置数据源] as UserConfigDataSource
  component [创建DataSource实体] as CreateDataSourceEntity
  component [测试数据连接] as TestDataConnection
  component [创建DataMapping映射] as CreateDataMappingEntity
  component [绑定到Component] as BindToComponentEntity
  component [实时数据获取] as RealTimeDataFetch
  component [组件渲染更新] as ComponentRenderUpdate
  
  component [JSON快速输入数据流] as JsonQuickInputFlow
  component [用户选择组件] as UserSelectComponent
  component [系统推荐JSON模板] as SystemRecommendTemplate
  component [用户选择或输入JSON] as UserInputJson
  component [验证JSON格式] as ValidateJsonFormat
  component [解析数据结构] as ParseDataStructure
  component [创建静态数据源] as CreateStaticDataSource
  component [自动渲染到组件属性] as AutoRenderToProperties
  
  component [协作同步数据流] as CollaborationFlow
  component [用户操作] as UserOperation
  component [生成操作事件] as GenerateOperationEvent
  component [协作服务接收] as CollaborationReceive
  component [广播给其他用户] as BroadcastToUsers
  component [状态合并] as StateMerge
  component [冲突解决] as ConflictResolve
  component [状态持久化] as StatePersist
  
  component [代码生成数据流] as CodeGenFlow
  component [用户触发导出] as UserTriggerExport
  component [读取Project和Component数据] as ReadProjectData
  component [代码生成器处理] as CodeGeneratorProcess
  component [生成React组件代码] as GenerateReactCode
  component [打包为项目文件] as PackageProject
  component [上传到对象存储] as UploadToStorage
  component [推送到Git仓库] as PushToGit
  
  component [Schema导出数据流] as SchemaExportFlow
  component [用户触发Schema导出] as UserTriggerSchemaExport
  component [读取Project完整数据] as ReadFullProjectData
  component [转换为PageSchema实体] as ConvertToPageSchema
  component [验证Schema格式] as ValidateSchemaFormat
  component [序列化为JSON] as SerializeToJSON
  component [下载Schema文件] as DownloadSchemaFile
  component [存储到对象存储] as StoreToObjectStorage
  
  component [Schema导入数据流] as SchemaImportFlow
  component [用户上传Schema文件] as UserUploadSchemaFile
  component [解析JSON数据] as ParseJSONData
  component [验证Schema版本] as ValidateSchemaVersion
  component [迁移旧版本Schema] as MigrateOldSchema
  component [转换为Project数据] as ConvertToProjectData
  component [导入到状态管理] as ImportToStateManagement
  component [渲染到画布] as RenderToCanvas
  
  ComponentEditFlow --> UserDragComponent
  ComponentEditFlow --> EditorCreateComponent
  ComponentEditFlow --> ServiceValidateData
  ComponentEditFlow --> StateUpdateLocal
  ComponentEditFlow --> CollaborationBroadcast
  ComponentEditFlow --> RepositoryPersist
  ComponentEditFlow --> CacheUpdate
  
  DataBindingFlow --> UserConfigDataSource
  DataBindingFlow --> CreateDataSourceEntity
  DataBindingFlow --> TestDataConnection
  DataBindingFlow --> CreateDataMappingEntity
  DataBindingFlow --> BindToComponentEntity
  DataBindingFlow --> RealTimeDataFetch
  DataBindingFlow --> ComponentRenderUpdate
  
  JsonQuickInputFlow --> UserSelectComponent
  JsonQuickInputFlow --> SystemRecommendTemplate
  JsonQuickInputFlow --> UserInputJson
  JsonQuickInputFlow --> ValidateJsonFormat
  JsonQuickInputFlow --> ParseDataStructure
  JsonQuickInputFlow --> CreateStaticDataSource
  JsonQuickInputFlow --> AutoRenderToProperties
  
  CollaborationFlow --> UserOperation
  CollaborationFlow --> GenerateOperationEvent
  CollaborationFlow --> CollaborationReceive
  CollaborationFlow --> BroadcastToUsers
  CollaborationFlow --> StateMerge
  CollaborationFlow --> ConflictResolve
  CollaborationFlow --> StatePersist
  
  CodeGenFlow --> UserTriggerExport
  CodeGenFlow --> ReadProjectData
  CodeGenFlow --> CodeGeneratorProcess
  CodeGenFlow --> GenerateReactCode
  CodeGenFlow --> PackageProject
  CodeGenFlow --> UploadToStorage
  CodeGenFlow --> PushToGit
  
  SchemaExportFlow --> UserTriggerSchemaExport
  SchemaExportFlow --> ReadFullProjectData
  SchemaExportFlow --> ConvertToPageSchema
  SchemaExportFlow --> ValidateSchemaFormat
  SchemaExportFlow --> SerializeToJSON
  SchemaExportFlow --> DownloadSchemaFile
  SchemaExportFlow --> StoreToObjectStorage
  
  SchemaImportFlow --> UserUploadSchemaFile
  SchemaImportFlow --> ParseJSONData
  SchemaImportFlow --> ValidateSchemaVersion
  SchemaImportFlow --> MigrateOldSchema
  SchemaImportFlow --> ConvertToProjectData
  SchemaImportFlow --> ImportToStateManagement
  SchemaImportFlow --> RenderToCanvas
}

' ============================================
' 数据访问关系
' ============================================

Component ..> PostgreSQL : 持久化
Template ..> PostgreSQL : 持久化
Project ..> PostgreSQL : 持久化
DataSource ..> PostgreSQL : 持久化
DataMapping ..> PostgreSQL : 持久化
User ..> PostgreSQL : 持久化
HistoryRecord ..> PostgreSQL : 持久化
PageSchema ..> ObjectStorage : 文件存储
JsonDataTemplate ..> PostgreSQL : 持久化（可选）

Component ..> Redis : 缓存
Project ..> Redis : 缓存
Project ..> ObjectStorage : 文件存储
PageSchema ..> Redis : 缓存

ComponentEditFlow --> PostgreSQL : 数据持久化
ComponentEditFlow --> Redis : 缓存更新

DataBindingFlow --> DataSource : 使用
DataBindingFlow --> DataMapping : 使用
DataBindingFlow --> Component : 绑定

JsonQuickInputFlow --> JsonDataTemplate : 使用
JsonQuickInputFlow --> DataSource : 创建
JsonQuickInputFlow --> Component : 更新属性

CollaborationFlow --> Redis : 消息队列
CollaborationFlow --> PostgreSQL : 状态持久化

CodeGenFlow --> Project : 读取
CodeGenFlow --> Component : 读取
CodeGenFlow --> ObjectStorage : 存储

SchemaExportFlow --> Project : 读取
SchemaExportFlow --> Component : 读取
SchemaExportFlow --> DataSource : 读取
SchemaExportFlow --> ThemeConfig : 读取
SchemaExportFlow --> PageSchema : 创建
SchemaExportFlow --> ObjectStorage : 存储

SchemaImportFlow --> PageSchema : 读取
SchemaImportFlow --> Project : 创建
SchemaImportFlow --> Component : 创建
SchemaImportFlow --> DataSource : 创建
SchemaImportFlow --> ThemeConfig : 创建
SchemaImportFlow --> Redis : 状态更新

JsonQuickInputFlow --> JsonDataTemplate : 使用
JsonQuickInputFlow --> DataSource : 创建
JsonQuickInputFlow --> Component : 更新属性

note right of PostgreSQL
  **数据访问模式：**
  - 读写分离
  - 主从复制
  - 分片策略（按项目ID）
  - 索引优化
end note

note right of Redis
  **缓存策略：**
  - 热点数据缓存
  - 会话数据存储
  - 协作状态同步
  - TTL过期策略
end note

@enduml
