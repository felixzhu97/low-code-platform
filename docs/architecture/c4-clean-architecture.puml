@startuml C4_CleanArchitecture
!include c4-plantuml/C4_Component.puml

title Component Diagram - 整洁架构层次结构

Person(designer, "页面设计师", "使用平台创建和编辑页面")

System_Boundary(web_app, "Web 应用容器") {

    ' ========== 表现层 (Presentation Layer) ==========
    System_Boundary(presentation, "表现层\n(Presentation Layer)") {
        Component(canvas, "Canvas 组件", "React", "可视化编辑画布")
        Component(component_panel, "ComponentPanel", "React", "组件选择面板")
        Component(properties_panel, "PropertiesPanel", "React", "属性编辑面板")
        Component(component_tree, "ComponentTree", "React", "组件树视图")
        Component(template_gallery, "TemplateGallery", "React", "模板库")
        Component(theme_editor, "ThemeEditor", "React", "主题编辑器")
        Component(code_export, "CodeExport", "React", "代码导出")

        Component(component_adapter, "ComponentAdapter", "TypeScript", "组件操作适配器")
        Component(canvas_adapter, "CanvasAdapter", "TypeScript", "画布操作适配器")
        Component(template_adapter, "TemplateAdapter", "TypeScript", "模板操作适配器")
        Component(adapter_factory, "AdapterFactory", "TypeScript", "适配器工厂")

        Component(use_adapters, "useAdapters Hook", "React Hook", "适配器访问 Hook")
        Component(use_all_stores, "useAllStores Hook", "React Hook", "状态访问 Hook")
    }

    ' ========== 应用层 (Application Layer) ==========
    System_Boundary(application, "应用层\n(Application Layer)") {
        Component(create_component_uc, "CreateComponentUseCase", "TypeScript", "创建组件用例")
        Component(update_component_uc, "UpdateComponentUseCase", "TypeScript", "更新组件用例")
        Component(delete_component_uc, "DeleteComponentUseCase", "TypeScript", "删除组件用例")
        Component(get_components_uc, "GetComponentsUseCase", "TypeScript", "获取组件用例")
        Component(update_position_uc, "UpdatePositionUseCase", "TypeScript", "更新位置用例")
        Component(apply_template_uc, "ApplyTemplateUseCase", "TypeScript", "应用模板用例")
        Component(update_canvas_uc, "UpdateCanvasStateUseCase", "TypeScript", "更新画布状态用例")

        Component(component_service, "ComponentManagementService", "TypeScript", "组件管理服务")
        Component(template_service, "TemplateService", "TypeScript", "模板服务")
        Component(data_binding_service, "DataBindingService", "TypeScript", "数据绑定服务")

        Component(component_repo_port, "IComponentRepositoryPort", "TypeScript Interface", "组件仓储端口")
        Component(template_repo_port, "ITemplateRepositoryPort", "TypeScript Interface", "模板仓储端口")
        Component(state_mgmt_port, "IStateManagementPort", "TypeScript Interface", "状态管理端口")
    }

    ' ========== 领域层 (Domain Layer) ==========
    System_Boundary(domain, "领域层\n(Domain Layer)") {
        Component(component_entity, "Component", "TypeScript Type", "组件实体")
        Component(template_entity, "Template", "TypeScript Type", "模板实体")
        Component(data_source_entity, "DataSource", "TypeScript Type", "数据源实体")
        Component(theme_config, "ThemeConfig", "TypeScript Type", "主题配置")

        Component(position_vo, "Position", "Value Object", "位置值对象")
        Component(style_vo, "Style", "Value Object", "样式值对象")

        Component(component_factory, "ComponentFactoryService", "TypeScript", "组件工厂服务")

        Component(component_repo_interface, "IComponentRepository", "TypeScript Interface", "组件仓储接口")
        Component(template_repo_interface, "ITemplateRepository", "TypeScript Interface", "模板仓储接口")
        Component(data_source_repo_interface, "IDataSourceRepository", "TypeScript Interface", "数据源仓储接口")
    }

    ' ========== 基础设施层 (Infrastructure Layer) ==========
    System_Boundary(infrastructure, "基础设施层\n(Infrastructure Layer)") {
        Component(component_store, "ComponentStore", "Zustand", "组件状态管理")
        Component(canvas_store, "CanvasStore", "Zustand", "画布状态管理")
        Component(theme_store, "ThemeStore", "Zustand", "主题状态管理")
        Component(data_store, "DataStore", "Zustand", "数据状态管理")
        Component(history_store, "HistoryStore", "Zustand", "历史记录管理")
        Component(ui_store, "UIStore", "Zustand", "UI 状态管理")

        Component(state_adapter, "ZustandStateAdapter", "TypeScript", "状态管理适配器")

        Component(component_repo_impl, "ComponentRepositoryImpl", "TypeScript", "组件仓储实现")
        Component(template_repo_impl, "TemplateRepositoryImpl", "TypeScript", "模板仓储实现")
        Component(data_source_repo_impl, "DataSourceRepositoryImpl", "TypeScript", "数据源仓储实现")

        Component(local_storage, "LocalStorage", "Browser API", "浏览器本地存储")
    }
}

' 表现层到应用层的依赖
Rel(component_adapter, create_component_uc, "调用")
Rel(component_adapter, update_component_uc, "调用")
Rel(component_adapter, delete_component_uc, "调用")
Rel(component_adapter, get_components_uc, "调用")
Rel(component_adapter, update_position_uc, "调用")
Rel(canvas_adapter, update_canvas_uc, "调用")
Rel(template_adapter, apply_template_uc, "调用")

Rel(component_adapter, component_repo_port, "使用")
Rel(component_adapter, state_mgmt_port, "使用")
Rel(canvas_adapter, state_mgmt_port, "使用")
Rel(template_adapter, template_repo_port, "使用")

' 应用层到领域层的依赖
Rel(create_component_uc, component_factory, "使用")
Rel(create_component_uc, component_repo_interface, "使用")
Rel(update_component_uc, component_repo_interface, "使用")
Rel(delete_component_uc, component_repo_interface, "使用")
Rel(get_components_uc, component_repo_interface, "使用")
Rel(apply_template_uc, template_repo_interface, "使用")

Rel(component_repo_port, component_repo_interface, "映射")
Rel(template_repo_port, template_repo_interface, "映射")
Rel(state_mgmt_port, component_store, "抽象")

' 基础设施层实现领域层接口
Rel(component_repo_interface, component_repo_impl, "实现")
Rel(template_repo_interface, template_repo_impl, "实现")
Rel(data_source_repo_interface, data_source_repo_impl, "实现")

' 基础设施层实现应用层端口
Rel(state_mgmt_port, state_adapter, "实现")
Rel(component_repo_port, component_repo_impl, "实现")
Rel(template_repo_port, template_repo_impl, "实现")

' 基础设施层内部依赖
Rel(state_adapter, component_store, "使用")
Rel(state_adapter, canvas_store, "使用")
Rel(state_adapter, theme_store, "使用")
Rel(state_adapter, history_store, "使用")

Rel(component_repo_impl, local_storage, "使用")
Rel(template_repo_impl, local_storage, "使用")
Rel(data_source_repo_impl, local_storage, "使用")

' 表现层组件使用适配器
Rel(canvas, use_adapters, "使用")
Rel(component_panel, use_adapters, "使用")
Rel(properties_panel, use_adapters, "使用")
Rel(use_adapters, adapter_factory, "使用")
Rel(adapter_factory, component_adapter, "创建")
Rel(adapter_factory, canvas_adapter, "创建")
Rel(adapter_factory, template_adapter, "创建")

SHOW_LEGEND()

@enduml

