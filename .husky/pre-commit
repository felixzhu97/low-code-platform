#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# 检查是否有 rust-wasm 相关的文件变更
RUST_WASM_DIR="packages/rust-wasm"
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# 检查是否有 Rust 相关文件被暂存
HAS_RUST_CHANGES=false
for file in $STAGED_FILES; do
  case "$file" in
    "$RUST_WASM_DIR/src/"*)
      HAS_RUST_CHANGES=true
      break
      ;;
    "$RUST_WASM_DIR/Cargo.toml")
      HAS_RUST_CHANGES=true
      break
      ;;
    "$RUST_WASM_DIR/Cargo.lock")
      HAS_RUST_CHANGES=true
      break
      ;;
  esac
done

# 如果 Rust 文件有变更，自动构建 WASM
if [ "$HAS_RUST_CHANGES" = true ]; then
  echo "🔍 检测到 Rust WASM 文件变更，自动构建 WASM..."
  
  # 检查 Rust 是否已安装
  if ! command -v rustc &> /dev/null; then
    echo "⚠️  警告: Rust 未安装，跳过 WASM 构建"
    echo "   请安装 Rust: curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh"
    exit 0
  fi
  
  # 检查 wasm-pack 是否已安装
  if ! command -v wasm-pack &> /dev/null; then
    echo "⚠️  警告: wasm-pack 未安装，跳过 WASM 构建"
    echo "   请安装 wasm-pack: cargo install wasm-pack"
    exit 0
  fi
  
  # 构建 WASM
  echo "🔨 构建 Rust WASM 模块..."
  if pnpm build:wasm; then
    echo "✅ WASM 构建成功"
    
    # 自动将构建好的文件添加到暂存区
    if [ -d "$RUST_WASM_DIR/pkg" ] && [ "$(ls -A $RUST_WASM_DIR/pkg 2>/dev/null)" ]; then
      git add "$RUST_WASM_DIR/pkg/"
      echo "✅ 已将构建的 WASM 文件添加到暂存区"
    else
      echo "⚠️  警告: pkg 目录为空，构建可能失败"
    fi
  else
    echo "❌ WASM 构建失败"
    echo "   提交将被阻止，请修复构建问题后重试"
    exit 1
  fi
fi

# 运行测试（如果需要）
pnpm test
