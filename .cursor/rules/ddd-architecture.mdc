---
description: 
globs: 
alwaysApply: false
---
# ä½ä»£ç å¹³å° DDD + åˆ†å±‚æ¶æ„æœ€ä½³å®è·µ

## æ¶æ„æ¦‚è¿°

æœ¬é¡¹ç›®é‡‡ç”¨ DDDï¼ˆé¢†åŸŸé©±åŠ¨è®¾è®¡ï¼‰+ åˆ†å±‚æ¶æ„æ¨¡å¼ï¼Œå°†ä»£ç æŒ‰èŒè´£æ¸…æ™°åˆ†å±‚ï¼Œç¡®ä¿é«˜å†…èšã€ä½è€¦åˆçš„ç³»ç»Ÿè®¾è®¡ã€‚

## åˆ†å±‚æ¶æ„

### 1. Domain Layer (é¢†åŸŸå±‚) - [src/domain/](mdc:src/domain)
**æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å±‚ï¼Œä¸ä¾èµ–ä»»ä½•å¤–éƒ¨æ¡†æ¶**

#### èŒè´£ï¼š
- å®šä¹‰ä¸šåŠ¡å®ä½“ (Entities)
- å®šä¹‰å€¼å¯¹è±¡ (Value Objects) 
- å®šä¹‰é¢†åŸŸæœåŠ¡ (Domain Services)
- å®šä¹‰ä»“å‚¨æ¥å£ (Repository Interfaces)
- å®šä¹‰é¢†åŸŸäº‹ä»¶ (Domain Events)

#### æ–‡ä»¶ç»“æ„ï¼š
```
src/domain/
â”œâ”€â”€ entities/           # ä¸šåŠ¡å®ä½“
â”‚   â”œâ”€â”€ types.ts       # å®ä½“ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ component.ts   # ç»„ä»¶å®ä½“
â”‚   â”œâ”€â”€ template.ts    # æ¨¡æ¿å®ä½“
â”‚   â””â”€â”€ project.ts     # é¡¹ç›®å®ä½“
â”œâ”€â”€ value-objects/     # å€¼å¯¹è±¡
â”‚   â”œâ”€â”€ position.ts    # ä½ç½®å€¼å¯¹è±¡
â”‚   â”œâ”€â”€ style.ts       # æ ·å¼å€¼å¯¹è±¡
â”‚   â””â”€â”€ config.ts      # é…ç½®å€¼å¯¹è±¡
â”œâ”€â”€ services/          # é¢†åŸŸæœåŠ¡
â”‚   â”œâ”€â”€ component-service.ts
â”‚   â””â”€â”€ template-service.ts
â”œâ”€â”€ repositories/      # ä»“å‚¨æ¥å£
â”‚   â”œâ”€â”€ component-repository.ts
â”‚   â””â”€â”€ template-repository.ts
â””â”€â”€ events/           # é¢†åŸŸäº‹ä»¶
    â”œâ”€â”€ component-created.ts
    â””â”€â”€ template-updated.ts
```

#### ç¤ºä¾‹å®ä½“ï¼š
å‚è€ƒ [src/domain/entities/types.ts](mdc:src/domain/entities/types.ts) çš„å®ç°æ–¹å¼

### 2. Application Layer (åº”ç”¨å±‚) - [src/application/](mdc:src/application)
**åº”ç”¨ä¸šåŠ¡é€»è¾‘å±‚ï¼Œåè°ƒé¢†åŸŸå¯¹è±¡å®Œæˆåº”ç”¨åœºæ™¯**

#### èŒè´£ï¼š
- å®šä¹‰åº”ç”¨æœåŠ¡ (Application Services)
- å®šä¹‰ç”¨ä¾‹ (Use Cases)
- å®šä¹‰DTO (Data Transfer Objects)
- å®šä¹‰åº”ç”¨æ¥å£ (Application Interfaces)
- äº‹åŠ¡ç®¡ç†

#### æ–‡ä»¶ç»“æ„ï¼š
```
src/application/
â”œâ”€â”€ services/          # åº”ç”¨æœåŠ¡
â”‚   â”œâ”€â”€ history.ts     # å†å²ç®¡ç†æœåŠ¡
â”‚   â”œâ”€â”€ utils.ts       # å·¥å…·æœåŠ¡
â”‚   â”œâ”€â”€ component-application-service.ts
â”‚   â””â”€â”€ template-application-service.ts
â”œâ”€â”€ use-cases/         # ç”¨ä¾‹
â”‚   â”œâ”€â”€ create-component.ts
â”‚   â”œâ”€â”€ update-template.ts
â”‚   â””â”€â”€ export-project.ts
â”œâ”€â”€ dto/              # æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚   â”œâ”€â”€ component-dto.ts
â”‚   â””â”€â”€ template-dto.ts
â”œâ”€â”€ interfaces/       # åº”ç”¨æ¥å£
â”‚   â”œâ”€â”€ component-application-service.interface.ts
â”‚   â””â”€â”€ template-application-service.interface.ts
â””â”€â”€ commands/         # å‘½ä»¤å¯¹è±¡
    â”œâ”€â”€ create-component-command.ts
    â””â”€â”€ update-template-command.ts
```

#### ç¤ºä¾‹åº”ç”¨æœåŠ¡ï¼š
å‚è€ƒ [src/application/services/history.ts](mdc:src/application/services/history.ts) å’Œ [src/application/services/utils.ts](mdc:src/application/services/utils.ts)

### 3. Presentation Layer (è¡¨ç°å±‚) - [src/presentation/](mdc:src/presentation)
**ç”¨æˆ·ç•Œé¢å±‚ï¼Œå¤„ç†ç”¨æˆ·äº¤äº’å’Œæ•°æ®å±•ç¤º**

#### èŒè´£ï¼š
- React ç»„ä»¶
- é¡µé¢è·¯ç”±
- ç”¨æˆ·äº¤äº’å¤„ç†
- æ•°æ®ç»‘å®šå’Œå±•ç¤º
- UI çŠ¶æ€ç®¡ç†

#### æ–‡ä»¶ç»“æ„ï¼š
```
src/presentation/
â”œâ”€â”€ components/        # ä¸šåŠ¡ç»„ä»¶
â”‚   â”œâ”€â”€ canvas.tsx     # ç”»å¸ƒç»„ä»¶
â”‚   â”œâ”€â”€ component-panel.tsx
â”‚   â”œâ”€â”€ properties-panel.tsx
â”‚   â””â”€â”€ template-gallery.tsx
â”œâ”€â”€ ui/               # åŸºç¡€UIç»„ä»¶
â”‚   â”œâ”€â”€ button.tsx
â”‚   â”œâ”€â”€ dialog.tsx
â”‚   â””â”€â”€ ...
â”œâ”€â”€ hooks/            # è‡ªå®šä¹‰Hooks
â”‚   â”œâ”€â”€ use-mobile.tsx
â”‚   â””â”€â”€ use-toast.ts
â”œâ”€â”€ styles/           # æ ·å¼æ–‡ä»¶
â”‚   â””â”€â”€ globals.css
â””â”€â”€ templates/        # æ¨¡æ¿ç»„ä»¶
    â””â”€â”€ dashboard-template.tsx
```

#### ç»„ä»¶ç¤ºä¾‹ï¼š
å‚è€ƒ [src/presentation/components/canvas.tsx](mdc:src/presentation/components/canvas.tsx) å’Œå…¶ä»–ç»„ä»¶çš„å®ç°

### 4. Infrastructure Layer (åŸºç¡€è®¾æ–½å±‚) - éœ€è¦è¡¥å……
**æŠ€æœ¯å®ç°å±‚ï¼Œæä¾›æŠ€æœ¯èƒ½åŠ›æ”¯æ’‘**

#### èŒè´£ï¼š
- æ•°æ®æŒä¹…åŒ–å®ç°
- å¤–éƒ¨APIè°ƒç”¨
- æ–‡ä»¶ç³»ç»Ÿæ“ä½œ
- ç¼“å­˜å®ç°
- ç¬¬ä¸‰æ–¹æœåŠ¡é›†æˆ

#### å»ºè®®æ–‡ä»¶ç»“æ„ï¼š
```
src/infrastructure/
â”œâ”€â”€ repositories/     # ä»“å‚¨å®ç°
â”‚   â”œâ”€â”€ component-repository.impl.ts
â”‚   â””â”€â”€ template-repository.impl.ts
â”œâ”€â”€ external-services/ # å¤–éƒ¨æœåŠ¡
â”‚   â”œâ”€â”€ api-client.ts
â”‚   â””â”€â”€ file-service.ts
â”œâ”€â”€ persistence/      # æŒä¹…åŒ–
â”‚   â”œâ”€â”€ database.ts
â”‚   â””â”€â”€ cache.ts
â””â”€â”€ config/          # é…ç½®
    â””â”€â”€ database-config.ts
```

## ä¾èµ–å…³ç³»è§„åˆ™

### ğŸš« ç¦æ­¢çš„ä¾èµ–å…³ç³»ï¼š
1. **Domain Layer** ä¸èƒ½ä¾èµ–ä»»ä½•å…¶ä»–å±‚
2. **Application Layer** åªèƒ½ä¾èµ– Domain Layer
3. **Infrastructure Layer** å¯ä»¥ä¾èµ– Domain å’Œ Application Layer
4. **Presentation Layer** åªèƒ½ä¾èµ– Application Layerï¼Œä¸èƒ½ç›´æ¥è®¿é—® Domain Layer

### âœ… å…è®¸çš„ä¾èµ–å…³ç³»ï¼š
```
Presentation â†’ Application â†’ Domain
Infrastructure â†’ Application â†’ Domain
```

## å‘½åçº¦å®š

### æ–‡ä»¶å‘½åï¼š
- å®ä½“æ–‡ä»¶ï¼š`kebab-case.ts` (å¦‚ `component-entity.ts`)
- æœåŠ¡æ–‡ä»¶ï¼š`kebab-case-service.ts` (å¦‚ `component-application-service.ts`)
- æ¥å£æ–‡ä»¶ï¼š`kebab-case.interface.ts`
- ç±»å‹æ–‡ä»¶ï¼š`kebab-case.types.ts`

### ç±»å‘½åï¼š
- å®ä½“ç±»ï¼š`PascalCase` (å¦‚ `ComponentEntity`)
- æœåŠ¡ç±»ï¼š`PascalCaseService` (å¦‚ `ComponentApplicationService`)
- æ¥å£ï¼š`IPascalCase` (å¦‚ `IComponentRepository`)

### æ–¹æ³•å‘½åï¼š
- é¢†åŸŸæœåŠ¡æ–¹æ³•ï¼šåŠ¨è¯ + åè¯ (å¦‚ `validateComponent`)
- åº”ç”¨æœåŠ¡æ–¹æ³•ï¼šç”¨ä¾‹åç§° (å¦‚ `createComponent`)
- ä»“å‚¨æ–¹æ³•ï¼šæ ‡å‡†CRUD (å¦‚ `findById`, `save`, `delete`)

## æœ€ä½³å®è·µ

### 1. å®ä½“è®¾è®¡
```typescript
// å¥½çš„å®ä½“è®¾è®¡
export class ComponentEntity {
  constructor(
    private readonly id: ComponentId,
    private readonly name: ComponentName,
    private properties: ComponentProperties
  ) {}

  // ä¸šåŠ¡æ–¹æ³•
  public updateProperties(properties: ComponentProperties): void {
    this.validateProperties(properties);
    this.properties = properties;
  }

  private validateProperties(properties: ComponentProperties): void {
    // éªŒè¯é€»è¾‘
  }
}
```

### 2. åº”ç”¨æœåŠ¡è®¾è®¡
```typescript
// å¥½çš„åº”ç”¨æœåŠ¡è®¾è®¡
export class ComponentApplicationService {
  constructor(
    private componentRepository: IComponentRepository,
    private eventPublisher: IEventPublisher
  ) {}

  async createComponent(command: CreateComponentCommand): Promise<ComponentDto> {
    const component = new ComponentEntity(
      command.id,
      command.name,
      command.properties
    );
    
    await this.componentRepository.save(component);
    await this.eventPublisher.publish(new ComponentCreatedEvent(component.id));
    
    return ComponentDto.fromEntity(component);
  }
}
```

### 3. ä»“å‚¨æ¥å£è®¾è®¡
```typescript
// å¥½çš„ä»“å‚¨æ¥å£è®¾è®¡
export interface IComponentRepository {
  findById(id: ComponentId): Promise<ComponentEntity | null>;
  findByProjectId(projectId: ProjectId): Promise<ComponentEntity[]>;
  save(component: ComponentEntity): Promise<void>;
  delete(id: ComponentId): Promise<void>;
}
```

## é”™è¯¯å¤„ç†

### é¢†åŸŸå±‚é”™è¯¯
```typescript
export class DomainError extends Error {
  constructor(message: string) {
    super(message);
    this.name = 'DomainError';
  }
}

export class ComponentValidationError extends DomainError {}
```

### åº”ç”¨å±‚é”™è¯¯
```typescript
export class ApplicationError extends Error {
  constructor(message: string) {
    super(message);
    this.name = 'ApplicationError';
  }
}

export class ComponentNotFoundError extends ApplicationError {}
```

## æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•
- é¢†åŸŸå®ä½“æµ‹è¯•ï¼šæµ‹è¯•ä¸šåŠ¡é€»è¾‘
- é¢†åŸŸæœåŠ¡æµ‹è¯•ï¼šæµ‹è¯•é¢†åŸŸè§„åˆ™
- åº”ç”¨æœåŠ¡æµ‹è¯•ï¼šæµ‹è¯•ç”¨ä¾‹åœºæ™¯

### é›†æˆæµ‹è¯•
- ä»“å‚¨å®ç°æµ‹è¯•
- å¤–éƒ¨æœåŠ¡é›†æˆæµ‹è¯•

### ç«¯åˆ°ç«¯æµ‹è¯•
- å®Œæ•´ç”¨æˆ·åœºæ™¯æµ‹è¯•

## è¿ç§»æŒ‡å—

### å½“å‰é¡¹ç›®æ”¹è¿›å»ºè®®ï¼š

1. **è¡¥å……Infrastructureå±‚**ï¼š
   - åˆ›å»º `src/infrastructure/` ç›®å½•
   - å®ç°ä»“å‚¨æ¨¡å¼
   - æ·»åŠ æ•°æ®æŒä¹…åŒ–

2. **å®Œå–„Domainå±‚**ï¼š
   - å°† [src/domain/entities/types.ts](mdc:src/domain/entities/types.ts) é‡æ„ä¸ºç‹¬ç«‹å®ä½“ç±»
   - æ·»åŠ å€¼å¯¹è±¡å’Œé¢†åŸŸæœåŠ¡

3. **é‡æ„Applicationå±‚**ï¼š
   - å°† [src/application/services/](mdc:src/application/services) æŒ‰DDDæ¨¡å¼é‡æ„
   - æ·»åŠ ç”¨ä¾‹å’ŒDTO

4. **ä¼˜åŒ–Presentationå±‚**ï¼š
   - ç¡®ä¿ç»„ä»¶åªè°ƒç”¨åº”ç”¨æœåŠ¡
   - æ·»åŠ é”™è¯¯è¾¹ç•Œå’ŒåŠ è½½çŠ¶æ€

è®°ä½ï¼šDDDçš„æ ¸å¿ƒæ˜¯å°†å¤æ‚çš„ä¸šåŠ¡é€»è¾‘å°è£…åœ¨é¢†åŸŸå±‚ï¼Œä¿æŒå„å±‚èŒè´£æ¸…æ™°ï¼Œé€šè¿‡æ¥å£è§£è€¦ï¼Œå®ç°å¯æµ‹è¯•ã€å¯ç»´æŠ¤çš„ä»£ç æ¶æ„ã€‚
